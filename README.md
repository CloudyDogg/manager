# Telegram-бот для управления закрытыми чатами

Бот позволяет автоматически добавлять пользователей в закрытые чаты без использования публичных ссылок через аккаунты администраторов.

## Функциональность

- Автоматическое добавление пользователей в два закрытых чата через аккаунты администраторов
- Ротация аккаунтов администраторов для избежания лимитов Telegram
- Проверка настроек приватности пользователей и предоставление инструкций
- Админ-панель для управления чатами и настройками
- Безопасное хранение сессий администраторов в зашифрованном виде

## Настройка и запуск

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка окружения
1. Создайте файл `.env` в корне проекта со следующими параметрами:
```
BOT_TOKEN=ваш_токен_бота
API_ID=ваш_pyrogram_api_id
API_HASH=ваш_pyrogram_api_hash
CHAT_ID_1=-1001234567890  # ID первого чата
CHAT_ID_2=-1009876543210  # ID второго чата
ADMIN_IDS=123456789,987654321  # ID администраторов через запятую
ENCRYPTION_KEY=ваш_ключ_шифрования  # Для шифрования сессий (32 символа)
```

2. Создайте папку `sessions` в корне проекта для хранения сессий:
```bash
mkdir sessions
```

### Запуск бота
```bash
python main.py
```

## Решение проблем

### Проблема с сессиями администраторов

Если вы видите ошибку "Не удалось запустить клиент админа" или "Сессия не найдена", выполните следующие шаги:

1. Убедитесь, что папка `sessions` существует в корне проекта
2. В панели администратора бота:
   - Выберите "Управление аккаунтами" -> "Добавить аккаунт"
   - Введите номер телефона администратора в международном формате (с "+")
   - Введите username администратора
   - Создайте сессию для этого аккаунта

### Ошибки формата номера телефона

Если возникают проблемы с форматом номера телефона при создании сессии, убедитесь, что:
- Номер начинается с "+" (например, "+79XXXXXXXXX")
- Введен корректный международный формат
- В имени файла сессии заменен "+" на "plus_" (если вы создаете файл вручную)

### Другие проблемы

Если у вас возникли другие проблемы:
1. Проверьте логи бота для выявления ошибок
2. Убедитесь, что все зависимости установлены
3. Проверьте корректность настроек в файле `.env`
4. Убедитесь, что администраторские аккаунты имеют права администратора в чатах

## Установка

### Требования

- Python 3.8 или выше
- Виртуальное окружение (рекомендуется)
- Доступ к API Telegram (api_id и api_hash)

### Шаги установки

1. Клонировать репозиторий:
```bash
git clone https://github.com/yourusername/telegram-chat-manager.git
cd telegram-chat-manager
```

2. Создать виртуальное окружение и активировать его:
```bash
python -m venv venv
source venv/bin/activate  # На Linux/Mac
venv\Scripts\activate     # На Windows
```

3. Установить зависимости:
```bash
pip install -r requirements.txt
```

4. Создать файл `.env` на основе примера и заполнить его:
```bash
cp .env.example .env
# Отредактировать .env, добавив TOKEN, API_ID и API_HASH
```

## Настройка

### Получение API-ключей Telegram

1. Перейдите на [my.telegram.org](https://my.telegram.org/auth)
2. Войдите в аккаунт
3. Выберите "API development tools"
4. Создайте новое приложение
5. Скопируйте API ID и API Hash в файл .env

### Создание бота у BotFather

1. Откройте [BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте токен бота в файл .env

### Добавление аккаунтов администраторов

1. Запустите бота
2. Используйте команду `/admin` (доступна только для пользователей из списка ADMIN_IDS)
3. Перейдите в "Управление аккаунтами" -> "Добавить аккаунт"
4. Следуйте инструкциям для добавления админского аккаунта

## Запуск бота

```bash
python main.py
```

## Использование

### Для пользователей

1. Пользователь находит бота и отправляет `/start`
2. Бот показывает меню с кнопкой "Хочу в чат"
3. Пользователь выбирает чат и подтверждает вступление
4. Бот пытается добавить пользователя через один из админских аккаунтов
5. Если добавление невозможно из-за настроек приватности, бот предоставляет инструкции

### Для администраторов

1. Администратор отправляет боту команду `/admin`
2. Доступны следующие функции:
   - Настройки чатов
   - Просмотр и управление пользователями
   - Обработка заявок
   - Управление аккаунтами администраторов
   - Просмотр статистики

## Структура проекта

- `main.py` - Точка входа приложения
- `config.py` - Конфигурация и настройки
- `db_manager.py` - Управление базой данных
- `session_manager.py` - Управление сессиями Pyrogram
- `chat_manager.py` - Логика работы с чатами
- `bot/` - Модули интерфейса бота
  - `user_interface.py` - Интерфейс для пользователей
  - `admin_interface.py` - Интерфейс для администраторов

## Техническая информация

### Используемые библиотеки

- **aiogram** - Фреймворк для создания Telegram ботов
- **pyrogram** - Клиент Telegram для работы с API
- **SQLAlchemy** - ORM для работы с базой данных
- **cryptography** - Шифрование сессий
- **python-dotenv** - Управление переменными окружения

### Безопасность

- Сессии администраторов хранятся в зашифрованном виде
- Ротация аккаунтов помогает избежать блокировок
- Логирование всех действий для аудита
- Проверка пользователей перед добавлением

## Лицензия

[MIT License](LICENSE) 