# Документация по Telegram-боту для добавления пользователей в чаты

## Принцип работы добавления пользователей в чаты

Бот использует **прямое добавление пользователей в чаты** через аккаунты администраторов, что имитирует ручное добавление администратором. Это решение более эффективно, чем использование ссылок-приглашений.

### Процесс добавления пользователя

1. **Инициация добавления**
   - Пользователь нажимает на кнопку выбора чата
   - Создается заявка в статусе "pending"
   - Пользователю отображается сообщение о том, что заявка обрабатывается

2. **Получение аккаунта администратора**
   - Система выбирает активный аккаунт администратора с наименьшим количеством использований
   - Происходит авторизация через сохраненную session_string

3. **Поиск целевого чата**
   - Бот получает список всех доступных чатов для админа
   - Находит нужный чат по его названию (сейчас ищет "test")
   - Именно **поиск по названию** решает проблему с идентификацией чата вместо прямого использования ID

4. **Прямое добавление пользователя**
   - Используется метод `add_chat_members` из Pyrogram
   - Этот метод добавляет пользователя напрямую как если бы администратор добавил его вручную
   - Пользователь получает уведомление об успешном добавлении

5. **Обработка возможных ошибок**
   - `UserPrivacyRestricted`: если настройки приватности пользователя запрещают прямое добавление, бот создает одноразовую ссылку и отправляет ее пользователю
   - `UserAlreadyParticipant`: если пользователь уже в чате, бот сообщает об этом
   - `PeerFlood`: если аккаунт администратора достиг лимита добавлений, он деактивируется

### Ключевые компоненты кода

```python
# Прямое добавление пользователя в чат
await admin_client.add_chat_members(
    chat_id=target_chat.id,
    user_ids=user_id
)
```

### Важные технические особенности

1. **Решение проблемы с ID чата**:
   - Вместо прямого использования числового ID чата (`-1002698797779`)
   - Бот ищет чат по названию в списке доступных диалогов администратора
   - Это решает проблему "PEER_ID_INVALID", так как работает с объектом чата, а не с его ID

2. **Ротация администраторов**:
   - При достижении лимита добавлений аккаунт администратора деактивируется
   - Система автоматически выбирает следующий доступный аккаунт

3. **Обработка ошибок приватности**:
   - Для пользователей с ограниченными настройками приватности
   - Создается одноразовая ссылка и отправляется как запасное решение

## Техническая реализация

### Функция `add_user_to_chat`

Ключевая функция для добавления пользователей в чат:

```python
async def add_user_to_chat(user_id, chat_id):
    """
    Прямое добавление пользователя в чат администратором
    """
    # Получаем клиент администратора
    admin_client = await get_admin_client()
    
    # Находим целевой чат по названию среди доступных для админа
    dialogs = []
    async for dialog in admin_client.get_dialogs():
        dialogs.append(dialog)
    
    target_chat = None
    for dialog in dialogs:
        if dialog.chat.title == "test":  # Ищем по названию чата
            target_chat = dialog.chat
            break
    
    # Прямое добавление пользователя
    await admin_client.add_chat_members(
        chat_id=target_chat.id,
        user_ids=user_id
    )
```

### Обработка обратного вызова при выборе чата

```python
@bot.on_callback_query(filters.regex(r"^select_chat_(\d+)$"))
async def select_chat_callback(client, callback_query):
    # Показываем сообщение о обработке
    await callback_query.edit_message_text(
        "⏳ Обрабатываем вашу заявку...\n\n"
        "Пожалуйста, подождите несколько секунд."
    )
    
    # Добавляем пользователя
    success, message = await add_user_to_chat(user_id, chat_id)
    
    # Далее обрабатываем результат добавления
```

## Настройка бота

### Важные переменные окружения

Для корректной работы в файле `.env` должны быть указаны:

```
BOT_TOKEN=123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZ
API_ID=123456
API_HASH=abcdef1234567890abcdef1234567890
ADMIN_IDS=123456789,987654321
CHAT_ID_1=-1002698797779
CHAT_ID_2=-1001234567890
```

### Важно: название чата!

Бот ищет чат по названию "test" - при необходимости измените это значение на реальное название вашего чата:

```python
if dialog.chat.title == "test":  # Изменить на нужное название чата
    target_chat = dialog.chat
    break
```

## Решение распространенных проблем

1. **Ошибка "Не удалось найти целевой чат"**:
   - Проверьте, что целевой чат действительно доступен аккаунту администратора
   - Убедитесь, что название чата в коде соответствует реальному названию

2. **Ошибка при добавлении из-за настроек приватности**:
   - Это нормальное поведение для пользователей с ограниченными настройками
   - Бот автоматически отправит им ссылку-приглашение

3. **Достигнут лимит добавлений**:
   - Telegram ограничивает количество добавлений с одного аккаунта
   - Добавьте дополнительные аккаунты администраторов для ротации

4. **Ошибка авторизации администратора**:
   - Используйте скрипт session_creator.py для создания новых сессий
   - Убедитесь, что аккаунт администратора не заблокирован 